apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  name: {{ $.Values.databaseName }}
  namespace: {{ $.Values.namespace }}
  annotations:
    app.oam.dev/publishVersion: {{ .Chart.AppVersion }}
    "helm.sh/resource-policy": keep
    "meta.helm.sh/release-name": {{ $.Values.databaseName }}
    "meta.helm.sh/release-namespace": {{ $.Values.namespace }}
    "app.kubernetes.io/managed-by": "Helm"
spec:
  components:
    - type: "postgres-cluster"
      name: {{ $.Values.databaseName }}
      properties:
        replicas: 3
        volume:
          size: 1000Gi
        resources:
          requests:
            cpu: "4000m"
            memory: "16Gi"
          limits:
            cpu: "6000m"
            memory: "24Gi"
        postgresql:
          parameters:
            max_connections: "1000"
            superuser_reserved_connections: "5"
            huge_pages: "try"
            max_wal_size: "6GB"
            max_locks_per_transaction: "256"
            max_pred_locks_per_transaction: "256"
            work_mem: "32MB"
            maintenance_work_mem: "512MB"
            shared_buffers: "4GB"
            wal_buffers: "512MB"
        ports:
          - expose: true
            port: 5432
            protocol: TCP
        preparedDatabases:
          {{- range $index, $network := .Values.networks }}
          chainsync_{{ $network }}:
            # https://postgres-operator.readthedocs.io/en/latest/user/#default-login-roles
            # chainsync_$network_{owner,writer,reader}_user
            defaultUsers: true

          {{- end }}
      traits:
        - type: annotations
          properties:
            "helm.sh/resource-policy": keep
            "meta.helm.sh/release-namespace": {{ $.Values.namespace }}
            "meta.helm.sh/release-name": {{ $.Values.databaseName }}
