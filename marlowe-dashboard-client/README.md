# Marlowe Run
Marlowe Run (formerly called the Marlowe Dashboard) is a DAPP that enables end users to run Marlowe contracts on the Cardano Blockchain.

The Marlowe Run FrontEnd is written in [PureScript](https://www.purescript.org/) and uses npm and [spago](https://github.com/purescript/spago) for managing dependencies. It talks to several backend services that needs to be up and running during development:

* [Cardano node](https://github.com/input-output-hk/cardano-node)
* [marlowe-pab](https://github.com/input-output-hk/marlowe-cardano/tree/master/marlowe/pab)
* [dashboard-server](https://github.com/input-output-hk/marlowe-cardano/tree/main/marlowe-dashboard-server)
* chain-index
* [wallet backend](https://github.com/input-output-hk/cardano-wallet)

The [marlowe-pab](https://github.com/input-output-hk/marlowe-cardano/tree/master/marlowe/pab) is a version of the [plutus-pab](https://github.com/input-output-hk/plutus-apps/tree/master/plutus-pab) with the Marlowe Plutus contracts built-in.

**Note 1**: _The current version of the application is an alpha release and it is targeted for developers to provide the necesary feedback to shape the final product. We encourage developers to try this on a testnet and [submit issues](https://github.com/input-output-hk/marlowe-cardano/issues/new/choose) to this repository._

**Note 2**: _The workflow described here relies heavily on Nix. **Make sure you have configured the [nix binary cache](https://github.com/input-output-hk/marlowe-cardano#how-to-set-up-the-iohk-binary-caches)** to avoid unnecesary builds. If you are using Mac and you run into a segmentation fault running `nix develop`, you can try running it as `GC_DONT_GC=1 nix develop` as this [issue suggest](https://github.com/NixOS/nix/issues/4246). You can also try alternatives to `nix develop` (that still relies on Nix) that has faster reloads when modifying the nix environment like [lorri](https://github.com/target/lorri) or [nix-direnv](https://github.com/nix-community/nix-direnv)._

## Getting started

To start the development environment enter `nix develop` and run the following command:

```bash
[nix develop shell] $ start-marlowe-run
```

This will start the necesary services in a [tmux](https://github.com/tmux/tmux/wiki) session. Once everything is ready you can access the frontend via [http://localhost:8009](http://localhost:8009).


If you are not familiar with tmux, you can watch [this playlist](https://www.youtube.com/watch?v=gmjyMxezIWU&list=PLT98CRl2KxKGiyV1u6wHDV8VwcQdzfuKe) to get an overview. One of the benefits of using Nix is that it allows us to offer a homogeneus development experience, so even if you don't have tmux installed on your machine, once you are inside `nix develop` you will have the same version as everybody else. Also included in nix develop shell are the Haskell and PureScript language server, `jq`, `cabal`, `nodejs`, `marlowe-cli` and others. The [dev-shell.nix](../dev-shell.nix) file shows all the tools provided out off the shelf.


### Running individual services
The previous command open up all backend and frontend services for you, but if you kill one, or want to start them separetly, you can use these commands in different windows/panes:

```bash
# BackEnd services
[nix develop shell] $ start-cardano-node
[nix develop shell] $ start-cardano-wallet
[nix develop shell] $ start-chain-index
[nix develop shell] $ start-marlowe-pab
[nix develop shell] $ start-dashboard-server
# FrontEnd service
[nix develop shell] $ cd marlowe-dashboard-client && npm run start
```

## FrontEnd Development Workflow

The `npm run start` script (invoked manually or via the `start-marlowe-run` command) will:

- Install npm dependencies
- Install spago dependencies
- Compile the PureScript code
- Start the Webpack server

There are other scripts and tools that can be used as part of the FE development process.


### Generating PureScript Code

The FE build depends on PureScript files that are generated by the backend using [purescript-bridge](https://github.com/eskimor/purescript-bridge). If you modify a Haskell data type that is needed by the FE you can run

```bash
[nix develop] $ marlowe-run-generate-purs
```

This will delete and recreate the `./generated` folder with bridge code generated by the backend. This code is commited in git and there is a CI check that validates that the current files are up to date.

### Building PureScript Code

We build the PureScript code using `spago`. You can invoke the following commands from the console

```bash
# Single build
[nix develop shell] $ spago build
# or watch mode
[nix develop shell] $ spago build -w
```

There is a convenience script that treats Warnings as Errors and omits the warnings in the `./generated` folder. This script can be run anywhere in the repository.

```bash
[nix develop shell] $ marlowe-run-spago
```

If you use VSCode with the [vscode-ide-plugin](https://github.com/nwolverson/vscode-ide-purescript) the language server is provided by nix and the project is built whenever you modify the code (so no need to run spago manually). In order to have the language server on PATH, VSCode should be launched from inside `nix develop` (using the `code` command).

**NOTE**: _The ide plugin works with a single PureScript project in the root, so VSCode should be launched from the marlowe-dashboard-client folder. You can use workspaces in order to have multiple roots at the same time._

### NPM Scripts

If you already have the backend PureScript files genereated and the project built you can open up the local webserver directly with:

```bash
$ npm run build:webpack:dev
```

To run the test you can use

```bash
$ npm t
```
Please refer to [package.json](./package.json) for the full set of provided scripts.

### Managing Dependencies

There are two relevant sources of dependencies that have to be handled and integrated with Nix separately: _Javascript(/npm)_ dependencies and _PureScript_ dependencies.

#### Managing NPM Dependencies

The Javascript dependencies are handled by npm in [package.json](./package.json) (and [package-lock.json](./package-lock.json) which is updated by npm automatically).

The npm dependencies are integrated with Nix via [npmlock2nix](https://github.com/tweag/npmlock2nix) almost completely transparently. Any changes to the lockfile will be picked up npmlock2nix automatically during the nix build. No additional files have to be generated or maintained.

##### NodeJS GitHub dependencies

In general, npm dependencies are handled by npmlock2nix automatically and transparently. The one exception to this rule are GitHub dependencies. In order for these to work in restricted evaluation mode (which is what hydra uses) you have to specify the sha256 of the dependency you want to use in your `buildNodeModules`. For example:

```
buildNodeModules {
    projectDir = ./.;
    packageJson = ./package.json;
    packageLockJson = ./package-lock.json;
    githubSourceHashMap = {
      shmish111.nearley-webpack-loader."939360f9d1bafa9019b6ff8739495c6c9101c4a1" = "1brx669dgsryakf7my00m25xdv7a02snbwzhzgc9ylmys4p8c10x";
    };
}
```

You can add new dependencies with the sha256 set to `"0000000000000000000000000000000000000000000000000000"`. This will yield an error message during the build with the actual hash value.

#### Managing PureScript Dependencies

The PureScript dependencies are handled by [spago](https://github.com/purescript/spago) in [packages.dhall](./packages.dhall).

The Nix integration is done using [spago2nix](https://github.com/justinwoo/spago2nix). Any changes to the PureScript dependencies require an update of the Nix code generated by spago2nix:

```
[nix develop shell] $ spago2nix generate
```

This will parse the spago configuration and will generate an updated `.nix` file.

### Custom Prelude

A custom prelude module called `Prologue` is available in web-common. It
exports everything from purescript-prelude, plus type and data constructors for
`Maybe`, `Either`, and `Tuple`, in addition to the `fst` and `snd` functions.
You can import this module instead of Prelude in your source files.
